# Monitoring

This guide covers monitoring, metrics, and observability for Trails in production environments.

## Metrics Collection

### Prometheus Integration

Trails provides built-in Prometheus metrics when enabled:

```json
{
  "prometheus": {
    "enabled": true,
    "port": 9090
  }
}
```

The metrics endpoint will be available at `http://localhost:9090/metrics`.

### Core Metrics

#### Command Metrics
- **`trails_commands_total`** (counter) - Total commands processed by type
  - Labels: `command_type`
- **`trails_command_duration_seconds`** (histogram) - Command processing latency
  - Labels: `command_type`
  - Buckets: 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10
- **`trails_command_errors_total`** (counter) - Command processing errors
  - Labels: `command_type`, `error_type`

#### Session Metrics
- **`trails_sessions_active`** (gauge) - Current number of active sessions
- **`trails_sessions_max`** (gauge) - Maximum sessions since startup
- **`trails_session_actions_total`** (counter) - Session lifecycle actions
  - Labels: `action` (create, delete, start, stop), `status` (success, error)

#### Engine Health
- **`trails_engine_uptime_seconds`** (gauge) - Engine uptime in seconds
- **`trails_workers_active`** (gauge) - Number of active command workers

#### Rate Limiting
- **`trails_rate_limit_hits_total`** (counter) - Rate limit violations
  - Labels: `session_id`

#### Event System
- **`trails_events_total`** (counter) - Events generated by type
  - Labels: `event_type`
- **`trails_events_dropped_total`** (counter) - Events dropped due to channel saturation
  - Labels: `event_type`

### Example Queries

**Command throughput:**
```promql
rate(trails_commands_total[5m])
```

**95th percentile command latency:**
```promql
histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m]))
```

**Error rate:**
```promql
rate(trails_command_errors_total[5m]) / rate(trails_commands_total[5m])
```

**Session utilization:**
```promql
trails_sessions_active / trails_sessions_max
```

## Logging

### Structured Logging

Trails uses structured logging with configurable levels:

```json
{
  "log_level": "info"
}
```

**Log Levels:**
- **debug**: Detailed internal operations (development only)
- **info**: Important operational events (default)
- **warn**: Warning conditions that don't affect operation
- **error**: Error conditions requiring attention

### Log Format

```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "level": "info",
  "msg": "Command processed successfully",
  "command_id": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
  "command_type": "CreateSession",
  "session_id": "01ARZ3NDEKTSV4RRFFQ69G5FBW",
  "duration_ms": 125,
  "worker_id": 2
}
```

### Key Log Events

#### Engine Lifecycle
```json
{"level": "info", "msg": "Engine started", "worker_count": 3, "max_sessions": 10}
{"level": "info", "msg": "Engine stopped gracefully"}
{"level": "warn", "msg": "Engine shutdown timeout exceeded"}
```

#### Command Processing
```json
{"level": "info", "msg": "Processing command", "command_type": "CreateSession", "command_id": "..."}
{"level": "error", "msg": "Command processing failed", "error": "session limit exceeded", "command_type": "CreateSession"}
{"level": "info", "msg": "Command processed successfully", "duration_ms": 125}
```

#### Rate Limiting
```json
{"level": "warn", "msg": "Rate limit exceeded", "session_id": "...", "limit_per_second": 10}
{"level": "info", "msg": "Rate limiter cache cleanup", "evicted": 5, "current_size": 95}
```

#### Session Management
```json
{"level": "info", "msg": "Session created", "session_id": "...", "name": "agent-workspace", "agent": "claude"}
{"level": "error", "msg": "Session creation failed", "error": "container startup timeout", "session_id": "..."}
```

#### Background Tasks
```json
{"level": "info", "msg": "State saved successfully", "sessions": 5, "file_size": 2048}
{"level": "warn", "msg": "Stale container cleanup", "containers_removed": 3, "age_hours": 25}
```

## Alerting

### Recommended Alerts

#### Critical Alerts (Page immediately)

**Engine Down**
```promql
up{job="trails"} == 0
```

**High Error Rate**
```promql
rate(trails_command_errors_total[5m]) / rate(trails_commands_total[5m]) > 0.05
```

**Command Processing Stopped**
```promql
rate(trails_commands_total[10m]) == 0 and trails_sessions_active > 0
```

#### Warning Alerts (Notify during business hours)

**High Command Latency**
```promql
histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m])) > 2.0
```

**Session Limit Approaching**
```promql
trails_sessions_active / trails_sessions_max > 0.8
```

**High Rate Limit Hits**
```promql
rate(trails_rate_limit_hits_total[5m]) > 1
```

**Events Being Dropped**
```promql
rate(trails_events_dropped_total[5m]) > 0
```

### Alert Configuration Example

```yaml
groups:
- name: trails
  rules:
  - alert: TrailsEngineDown
    expr: up{job="trails"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Trails engine is down"
      description: "Trails engine has been down for more than 1 minute"

  - alert: TrailsHighErrorRate
    expr: rate(trails_command_errors_total[5m]) / rate(trails_commands_total[5m]) > 0.05
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High error rate in Trails"
      description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"

  - alert: TrailsHighLatency
    expr: histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m])) > 2.0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High command latency in Trails"
      description: "95th percentile latency is {{ $value }}s over the last 5 minutes"
```

## Dashboards

### Grafana Dashboard

Key panels for a Trails monitoring dashboard:

#### Overview Row
- **Uptime**: `trails_engine_uptime_seconds`
- **Active Sessions**: `trails_sessions_active`
- **Command Rate**: `rate(trails_commands_total[5m])`
- **Error Rate**: `rate(trails_command_errors_total[5m])`

#### Performance Row
- **Command Latency (P50, P95, P99)**:
  ```promql
  histogram_quantile(0.50, rate(trails_command_duration_seconds_bucket[5m]))
  histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m]))
  histogram_quantile(0.99, rate(trails_command_duration_seconds_bucket[5m]))
  ```
- **Commands by Type**: `rate(trails_commands_total[5m]) by (command_type)`
- **Worker Utilization**: `trails_workers_active`

#### Errors Row
- **Error Rate by Type**: `rate(trails_command_errors_total[5m]) by (error_type)`
- **Rate Limit Hits**: `rate(trails_rate_limit_hits_total[5m])`
- **Dropped Events**: `rate(trails_events_dropped_total[5m]) by (event_type)`

#### Sessions Row
- **Session Actions**: `rate(trails_session_actions_total[5m]) by (action, status)`
- **Session Utilization**: `trails_sessions_active / trails_sessions_max`
- **Session History**: `trails_sessions_active` (time series)

### Sample Dashboard JSON

```json
{
  "dashboard": {
    "id": null,
    "title": "Trails Monitoring",
    "tags": ["trails"],
    "timezone": "browser",
    "panels": [
      {
        "title": "Command Rate",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(trails_commands_total[5m])",
            "legendFormat": "commands/sec"
          }
        ]
      },
      {
        "title": "Command Latency",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(trails_command_duration_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m]))",
            "legendFormat": "P95"
          }
        ]
      }
    ]
  }
}
```

## Health Checks

### Built-in Health Endpoint

When Prometheus is enabled, a health endpoint is available:

```bash
curl http://localhost:9090/health
# Response: OK (200)
```

### Health Command

The engine also supports health check commands:

```json
{
  "type": "health_check",
  "payload": {
    "include_details": true
  }
}
```

Response:
```json
{
  "type": "health_status",
  "payload": {
    "healthy": true,
    "details": {
      "status": "healthy",
      "active_sessions": 5,
      "rate_limiters": 12,
      "worker_count": 3,
      "max_sessions": 10,
      "uptime_seconds": 3600
    }
  }
}
```

### Kubernetes Health Checks

For Kubernetes deployments:

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 9090
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /health
    port: 9090
  initialDelaySeconds: 5
  periodSeconds: 5
```

## Performance Monitoring

### Key Performance Indicators

1. **Throughput**: Commands processed per second
2. **Latency**: P95 command processing time
3. **Error Rate**: Percentage of failed commands
4. **Resource Utilization**: Session count, memory, CPU
5. **System Health**: Uptime, worker availability

### Performance Baselines

**Good Performance:**
- Command latency P95 < 500ms
- Error rate < 1%
- Session utilization < 80%
- Rate limit hits < 5/minute

**Investigation Thresholds:**
- Command latency P95 > 1s
- Error rate > 5%
- Session utilization > 90%
- Rate limit hits > 20/minute

### Capacity Planning

Monitor these metrics for capacity planning:

- **Session Growth**: Track `trails_sessions_active` trends
- **Command Load**: Monitor `rate(trails_commands_total[1h])` patterns
- **Resource Usage**: CPU, memory, disk I/O patterns
- **Error Patterns**: Identify scaling bottlenecks

## Troubleshooting

### Common Monitoring Issues

**Metrics Not Available**
- Check Prometheus configuration is enabled
- Verify metrics port is accessible
- Check for port conflicts

**High Memory Usage**
- Monitor rate limiter cache size
- Check for event channel backlog
- Verify session cleanup is working

**Alert Fatigue**
- Tune alert thresholds based on baseline
- Use alert routing and suppression
- Group related alerts

### Debug Metrics

Enable debug logging to get additional metrics context:

```json
{
  "log_level": "debug"
}
```

Debug logs include:
- Rate limiter cache statistics
- Event channel buffer levels
- Worker queue depths
- Detailed error context

## Related Documentation

- [Configuration](./configuration.md) - Metrics and logging configuration
- [Deployment](./deployment.md) - Production deployment setup
- [Engine Component](../components/engine.md) - Engine architecture and internals
- [Troubleshooting](./troubleshooting.md) - Common issues and solutions