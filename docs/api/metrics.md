# Metrics API Reference

This document provides comprehensive reference for all metrics exposed by Trails, including Prometheus metrics, health endpoints, and performance indicators.

## Prometheus Metrics

When Prometheus integration is enabled, Trails exposes metrics at `/metrics` endpoint.

### Configuration

Enable Prometheus metrics in your configuration:

```json
{
  "prometheus": {
    "enabled": true,
    "port": 9090
  }
}
```

Access metrics at: `http://localhost:9090/metrics`

### Command Metrics

#### `trails_commands_total`
**Type**: Counter  
**Description**: Total number of commands processed by type  
**Labels**: 
- `command_type`: Type of command (create_session, start_agent, etc.)

**Example:**
```
trails_commands_total{command_type="create_session"} 42
trails_commands_total{command_type="start_agent"} 38
trails_commands_total{command_type="health_check"} 156
```

**Usage:**
```promql
# Command rate over last 5 minutes
rate(trails_commands_total[5m])

# Commands by type
sum(rate(trails_commands_total[5m])) by (command_type)
```

#### `trails_command_duration_seconds`
**Type**: Histogram  
**Description**: Command processing duration in seconds  
**Labels**: 
- `command_type`: Type of command

**Buckets**: 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10

**Example:**
```
trails_command_duration_seconds_bucket{command_type="create_session",le="0.1"} 35
trails_command_duration_seconds_bucket{command_type="create_session",le="0.25"} 42
trails_command_duration_seconds_sum{command_type="create_session"} 8.45
trails_command_duration_seconds_count{command_type="create_session"} 42
```

**Usage:**
```promql
# 95th percentile latency
histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m]))

# Average latency by command type
rate(trails_command_duration_seconds_sum[5m]) / rate(trails_command_duration_seconds_count[5m])
```

#### `trails_command_errors_total`
**Type**: Counter  
**Description**: Total number of command processing errors  
**Labels**: 
- `command_type`: Type of command that failed
- `error_type`: Category of error (validation, resource, system, etc.)

**Example:**
```
trails_command_errors_total{command_type="create_session",error_type="validation"} 3
trails_command_errors_total{command_type="start_agent",error_type="resource"} 1
```

**Usage:**
```promql
# Error rate
rate(trails_command_errors_total[5m]) / rate(trails_commands_total[5m])

# Errors by type
sum(rate(trails_command_errors_total[5m])) by (error_type)
```

### Session Metrics

#### `trails_sessions_active`
**Type**: Gauge  
**Description**: Current number of active sessions  

**Example:**
```
trails_sessions_active 7
```

**Usage:**
```promql
# Current active sessions
trails_sessions_active

# Session utilization
trails_sessions_active / trails_sessions_max
```

#### `trails_sessions_max`
**Type**: Gauge  
**Description**: Maximum number of sessions since engine start  

**Example:**
```
trails_sessions_max 10
```

#### `trails_session_actions_total`
**Type**: Counter  
**Description**: Total number of session lifecycle actions  
**Labels**: 
- `action`: Session action (create, delete, start, stop, restart)
- `status`: Result status (success, error)

**Example:**
```
trails_session_actions_total{action="create",status="success"} 45
trails_session_actions_total{action="create",status="error"} 2
trails_session_actions_total{action="start",status="success"} 38
```

**Usage:**
```promql
# Session creation success rate
rate(trails_session_actions_total{action="create",status="success"}[5m]) / 
rate(trails_session_actions_total{action="create"}[5m])
```

### Engine Health Metrics

#### `trails_engine_uptime_seconds`
**Type**: Gauge  
**Description**: Engine uptime in seconds  

**Example:**
```
trails_engine_uptime_seconds 7245.6
```

**Usage:**
```promql
# Uptime in hours
trails_engine_uptime_seconds / 3600

# Recent restarts (uptime < 1 hour)
trails_engine_uptime_seconds < 3600
```

#### `trails_workers_active`
**Type**: Gauge  
**Description**: Number of active command worker goroutines  

**Example:**
```
trails_workers_active 3
```

### Rate Limiting Metrics

#### `trails_rate_limit_hits_total`
**Type**: Counter  
**Description**: Total number of rate limit violations  
**Labels**: 
- `session_id`: Session that hit rate limit

**Example:**
```
trails_rate_limit_hits_total{session_id="01ARZ3NDEKTSV4RRFFQ69G5FAV"} 5
trails_rate_limit_hits_total{session_id="01ARZ3NDEKTSV4RRFFQ69G5FBW"} 2
```

**Usage:**
```promql
# Rate limit hit rate
rate(trails_rate_limit_hits_total[5m])

# Top sessions hitting rate limits
topk(5, rate(trails_rate_limit_hits_total[5m]))
```

### Event System Metrics

#### `trails_events_total`
**Type**: Counter  
**Description**: Total number of events generated by type  
**Labels**: 
- `event_type`: Type of event (session_created, status_changed, etc.)

**Example:**
```
trails_events_total{event_type="session_created"} 42
trails_events_total{event_type="status_changed"} 156
trails_events_total{event_type="error"} 8
```

**Usage:**
```promql
# Event generation rate
rate(trails_events_total[5m])

# Error event rate
rate(trails_events_total{event_type="error"}[5m])
```

#### `trails_events_dropped_total`
**Type**: Counter  
**Description**: Total number of events dropped due to channel saturation  
**Labels**: 
- `event_type`: Type of event that was dropped

**Example:**
```
trails_events_dropped_total{event_type="status_changed"} 3
```

**Usage:**
```promql
# Event drop rate
rate(trails_events_dropped_total[5m])

# Drop rate as percentage of total events
rate(trails_events_dropped_total[5m]) / rate(trails_events_total[5m]) * 100
```

## Health Endpoints

### `/health`
**Method**: GET  
**Description**: Basic health check endpoint  
**Response**: `OK` (200) or error status  

**Example:**
```bash
curl http://localhost:9090/health
# Response: OK
```

### Health Check Command
**Command Type**: `health_check`  
**Description**: Detailed health information via command protocol  

**Request:**
```json
{
  "id": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
  "type": "health_check",
  "timestamp": "2025-01-15T10:30:00Z",
  "payload": {
    "include_details": true
  }
}
```

**Response:**
```json
{
  "id": "01ARZ3NDEKTSV4RRFFQ69G5FBW",
  "type": "health_status",
  "timestamp": "2025-01-15T10:30:00Z",
  "metadata": {
    "event_id": "01ARZ3NDEKTSV4RRFFQ69G5FBX",
    "command_id": "01ARZ3NDEKTSV4RRFFQ69G5FAV",
    "correlation_id": "01ARZ3NDEKTSV4RRFFQ69G5FBY"
  },
  "payload": {
    "healthy": true,
    "details": {
      "status": "healthy",
      "active_sessions": 5,
      "rate_limiters": 12,
      "worker_count": 3,
      "max_sessions": 10,
      "uptime_seconds": 3600
    }
  }
}
```

**Health Status Fields:**
- **`healthy`**: Overall health status (boolean)
- **`status`**: String status ("healthy", "degraded", "unhealthy")
- **`active_sessions`**: Current number of active sessions
- **`rate_limiters`**: Number of active rate limiters in cache
- **`worker_count`**: Number of command worker goroutines
- **`max_sessions`**: Maximum allowed concurrent sessions
- **`uptime_seconds`**: Engine uptime in seconds

## In-Memory Metrics

When Prometheus is disabled, metrics are stored in memory and available via the `GetMetrics()` method.

### MetricsSnapshot Structure

```go
type MetricsSnapshot struct {
    CommandCounts       map[protocol.CommandType]int64           `json:"command_counts"`
    CommandDurations    map[protocol.CommandType]DurationStats  `json:"command_durations"`
    ErrorCounts         map[string]int64                         `json:"error_counts"`
    CurrentSessionCount int                                      `json:"current_session_count"`
    MaxSessionCount     int                                      `json:"max_session_count"`
    Uptime              time.Duration                            `json:"uptime"`
    Timestamp           time.Time                                `json:"timestamp"`
}

type DurationStats struct {
    Count   int           `json:"count"`
    Mean    time.Duration `json:"mean"`
    Min     time.Duration `json:"min"`
    Max     time.Duration `json:"max"`
    P50     time.Duration `json:"p50"`
    P95     time.Duration `json:"p95"`
    P99     time.Duration `json:"p99"`
}
```

### Example Snapshot

```json
{
  "command_counts": {
    "create_session": 42,
    "start_agent": 38,
    "health_check": 156
  },
  "command_durations": {
    "create_session": {
      "count": 42,
      "mean": "201ms",
      "min": "95ms",
      "max": "450ms",
      "p50": "195ms",
      "p95": "380ms",
      "p99": "430ms"
    }
  },
  "error_counts": {
    "command_processing": 3,
    "rate_limit_exceeded": 5
  },
  "current_session_count": 7,
  "max_session_count": 10,
  "uptime": "2h5m30s",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

## Custom Metrics

### IncrementCounter

The `IncrementCounter` method allows tracking custom metrics:

```go
metrics.IncrementCounter("events.dropped", map[string]string{
    "type": "session_created",
})

metrics.IncrementCounter("rate_limit.hit", map[string]string{
    "session_id": sessionID,
})

metrics.IncrementCounter("session.action", map[string]string{
    "action": "create",
    "status": "success",
})
```

**Supported Counters:**
- `events.dropped` - Dropped events by type
- `events.sent` - Successfully sent events by type
- `rate_limit.hit` - Rate limit hits by session
- `session.action` - Session actions by type and status

## Alerting Metrics

### Critical Alerts

**Engine Down**
```promql
up{job="trails"} == 0
```

**High Error Rate**
```promql
rate(trails_command_errors_total[5m]) / rate(trails_commands_total[5m]) > 0.05
```

**No Command Processing**
```promql
rate(trails_commands_total[10m]) == 0 and trails_sessions_active > 0
```

### Warning Alerts

**High Latency**
```promql
histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m])) > 2.0
```

**Session Limit Approaching**
```promql
trails_sessions_active / trails_sessions_max > 0.8
```

**High Rate Limit Hits**
```promql
rate(trails_rate_limit_hits_total[5m]) > 1
```

**Events Being Dropped**
```promql
rate(trails_events_dropped_total[5m]) > 0
```

## Performance Baselines

### Good Performance Indicators

- **Command Latency P95**: < 500ms
- **Error Rate**: < 1%
- **Session Utilization**: < 80%
- **Rate Limit Hits**: < 5/minute
- **Event Drop Rate**: 0%

### Investigation Thresholds

- **Command Latency P95**: > 1s
- **Error Rate**: > 5%
- **Session Utilization**: > 90%
- **Rate Limit Hits**: > 20/minute
- **Event Drop Rate**: > 0.1%

## Capacity Planning Metrics

Monitor these for capacity planning:

1. **Session Growth Trend**
   ```promql
   increase(trails_sessions_max[24h])
   ```

2. **Command Load Pattern**
   ```promql
   rate(trails_commands_total[1h])
   ```

3. **Peak Session Usage**
   ```promql
   max_over_time(trails_sessions_active[24h])
   ```

4. **Error Rate Trend**
   ```promql
   rate(trails_command_errors_total[24h])
   ```

## Integration Examples

### Grafana Dashboard Query Examples

**Overview Panel - Command Rate**
```promql
sum(rate(trails_commands_total[5m]))
```

**Latency Panel - Command Duration Percentiles**
```promql
histogram_quantile(0.50, rate(trails_command_duration_seconds_bucket[5m]))
histogram_quantile(0.95, rate(trails_command_duration_seconds_bucket[5m]))
histogram_quantile(0.99, rate(trails_command_duration_seconds_bucket[5m]))
```

**Error Panel - Error Rate by Type**
```promql
rate(trails_command_errors_total[5m]) by (error_type)
```

### Alertmanager Configuration

```yaml
route:
  routes:
  - match:
      service: trails
    receiver: trails-alerts
    group_by: [alertname, instance]
    group_wait: 10s
    group_interval: 5m
    repeat_interval: 1h

receivers:
- name: trails-alerts
  slack_configs:
  - channel: '#alerts'
    title: 'Trails Alert: {{ .GroupLabels.alertname }}'
    text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
```

## Related Documentation

- [Monitoring](../operations/monitoring.md) - Complete monitoring setup guide
- [Engine Component](../components/engine.md) - Engine architecture and metrics collection
- [Configuration](./configuration.md) - Metrics configuration options
- [Troubleshooting](../operations/troubleshooting.md) - Using metrics for troubleshooting